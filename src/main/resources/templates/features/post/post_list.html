<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <th:block th:insert="~{fragments/head :: common-head('Post')}"></th:block>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <meta name="gmaps-api-key" th:content="${@environment.getProperty('google.maps.api-key')}"/>
  <link rel="stylesheet" th:href="@{/features/post/css/modal-common.css}">
  <link rel="stylesheet" th:href="@{/features/post/css/post_write.css}">
  <link rel="stylesheet" th:href="@{/features/post/css/post_list.css}">
  <link rel="stylesheet" th:href="@{/features/post/css/post_detail.css}">
</head>
<body>

<div th:replace="~{fragments/header :: common-header}"></div>

<div class="page-wrapper">
  <!-- 게시글 페이지 배너 -->
  <section class="post-banner" aria-label="방문 인증 안내 배너">
    <div class="post-banner__inner">
      <!-- 왼쪽 일러스트 -->
      <div class="post-banner__visual" aria-hidden="true">
        <img
            class="post-banner__img"
            th:src="@{/images/banner/stamp-banner.png}"
            src="/images/banner/stamp-banner.png"
            alt=""
            loading="eager"
        />
      </div>

      <!-- 오른쪽 카피 -->
      <div class="post-banner__copy">
        <h2 class="post-banner__title">
          문화 유산지를 방문하고, 방문 인증글을 남기면<br>
          우표와 점수를 얻을 수 있어요!
        </h2>
      </div>
    </div>
  </section>
  <main class="main-content container-max">
    <!-- 검색/필터 -->
    <section class="search-filter-section">
      <form th:action="@{/posts}" method="get" class="search-form" id="searchForm">
        <div class="search-container">
          <input type="text" name="keyword" th:value="${param.keyword}"
                 placeholder="문화유산 또는 지역을 입력해주세요" class="search-input" id="searchInput">
          <button type="submit" class="search-btn" title="검색">검색</button>
        </div>

        <div class="post-filter-controls">
          <div class="post-filters-left">
            <div class="post-filter region-filter">
              <div class="custom-select">
                <div class="select-trigger" onclick="toggleRegionDropdown(this)">
                  <span class="selected-text" th:text="${#strings.isEmpty(region)} ? '전체 지역' : ${T(org.hh.heritagehunters.domain.search.util.RegionCodeMapper).getKoreanName(region)}">전체 지역</span>
                  <span class="select-arrow">▼</span>
                </div>
                <div class="select-options">
                  <div class="select-option" data-value="" onclick="selectOption(this)">전체 지역</div>
                  <div th:each="entry : ${T(org.hh.heritagehunters.domain.search.util.RegionCodeMapper).getCodeMap()}"
                       th:if="${entry.key != '00'}"
                       class="select-option"
                       th:data-value="${entry.key}"
                       onclick="selectOption(this)"
                       th:text="${entry.value}"></div>
                </div>
              </div>
              <input type="hidden" name="region" th:value="${region}" id="regionInput">
            </div>

            <div class="post-filter sort-filter">
              <div class="sort-filter-tabs">
                <input type="radio" name="sort" value="createdAt" id="sort-time"
                       th:checked="${sort == null or sort == 'createdAt'}"
                       onchange="submitForm()">
                <label for="sort-time" class="sort-tab"
                       th:classappend="${sort == null or sort == 'createdAt' ? 'active-sort' : ''}">최신순</label>

                <input type="radio" name="sort" value="viewCount" id="sort-view"
                       th:checked="${sort == 'viewCount'}" onchange="submitForm()">
                <label for="sort-view" class="sort-tab"
                       th:classappend="${sort == 'viewCount' ? 'active-sort' : ''}">조회순</label>

                <input type="radio" name="sort" value="likeCount" id="sort-like"
                       th:checked="${sort == 'likeCount'}" onchange="submitForm()">
                <label for="sort-like" class="sort-tab"
                       th:classappend="${sort == 'likeCount' ? 'active-sort' : ''}">좋아요순</label>

                <input type="radio" name="sort" value="commentCount" id="sort-comment"
                       th:checked="${sort == 'commentCount'}" onchange="submitForm()">
                <label for="sort-comment" class="sort-tab"
                       th:classappend="${sort == 'commentCount' ? 'active-sort' : ''}">댓글순</label>
              </div>
            </div>
          </div>

          <div class="post-actions-right">
            <button type="button" id="clearFiltersBtn" class="post-action-btn reset-btn">초기화
            </button>
            <button type="button" id="openPostModal" class="post-action-btn new-post-btn"
                    sec:authorize="isAuthenticated()" data-action="open-post-modal">게시글 작성
            </button>
          </div>
        </div>

        <input type="hidden" name="direction" th:value="${param.direction ?: 'desc'}">
        <input type="hidden" name="page" value="0">
      </form>
      <div class="search-filter-divider"></div>
    </section>

    <!-- 게시글 그리드 -->
    <section class="posts-main-section">
      <div class="posts-grid" id="postsContainer" th:if="${posts != null and !posts.empty}">
        <article class="post-card"
                 th:each="post, stat : ${posts.content}"
                 th:data-post-id="${post.id}"
                 th:data-index="${stat.index}">

          <!-- 클릭 이동: 이미지 + 유물 종류 -->
          <div class="post-link" th:data-post-id="${post.id}" data-action="open-detail"
               style="cursor: pointer;">

            <!-- ① 이미지 -->
            <div class="post-image-container">
              <img th:if="${post.mainImageUrl != null and !post.mainImageUrl.isEmpty()}"
                   th:src="${post.mainImageUrl}"
                   th:alt="${(post.heritage != null ? post.heritage.name : '사진') + ' - ' + post.content}"
                   class="post-image" loading="lazy">
              <div class="image-count-badge"
                   th:if="${post.images != null and #lists.size(post.images) > 1}">
                <img class="camera-svg" th:src="@{/images/icons/cards.svg}"/> <span
                  th:text="${#lists.size(post.images)}">2</span>
              </div>
            </div>

            <!-- ② 유물 종류 -->
            <div class="post-info compact">
              <div class="designation-row">
              <span class="designation-pill"
                    th:text="${post.heritage != null ? T(org.hh.heritagehunters.domain.search.util.DesignationCodeMapper).getKoreanName(post.heritage.designation) : '미분류'}">
                미분류
              </span>
              </div>
            </div>
          </div>

          <!-- ③ 액션(좋아요/댓글) : a 바깥 -->
          <div class="post-actions" sec:authorize="isAuthenticated()">
            <div class="action-item">
              <button type="button" class="icon-action like-button"
                      th:data-post-id="${post.id}"
                      th:classappend="${post.likedByCurrentUser} ? ' liked' : ''"
                      th:attr="aria-pressed=${post.likedByCurrentUser}"
                      title="좋아요">
                <!-- 하트 -->
                <img th:src="${post.likedByCurrentUser} ? '/images/icons/heart-filled.svg' : '/images/icons/heart-empty.svg'" 
                     alt="좋아요" width="24" height="24" />
              </button>
              <span class="action-count" th:text="${post.likeCount}">0</span>
            </div>

            <div class="action-item">
              <button class="icon-action comment-btn"
                      th:data-post-id="${post.id}" data-action="open-detail-comment" title="댓글 달기">
                <!-- 말풍선 -->
                <img th:src="@{/images/icons/comment.svg}" alt="댓글" width="24" height="24" />
              </button>
              <span class="action-count" th:text="${post.commentCount}">0</span>
            </div>
          </div>

          <!-- 비로그인: 통계만 -->
          <div class="post-actions" sec:authorize="!isAuthenticated()">
            <div class="action-item">
              <span class="icon-action">
                <img th:src="@{/images/icons/heart-empty.svg}" alt="좋아요" width="24" height="24" />
              </span>
              <span class="action-count" th:text="${post.likeCount}">0</span>
            </div>
            
            <div class="action-item">
              <span class="icon-action">
                <img th:src="@{/images/icons/comment.svg}" alt="댓글" width="24" height="24" />
              </span>
              <span class="action-count" th:text="${post.commentCount}">0</span>
            </div>
          </div>

          <!-- ⑤ 작성 날짜 -->
          <div class="post-meta">
            <time class="post-date" th:datetime="${post.createdAt}"
                  th:text="${#temporals.format(post.createdAt, 'yy/MM/dd')}">25/08/05
            </time>
          </div>
        </article>
      </div>

      <div class="no-posts-message" th:if="${posts == null or posts.empty}">
        <p>게시글이 없습니다. <br> 문화유산을 탐험하고, 새로운 게시글을 작성해보세요!</p>
      </div>

      <!-- 페이지네이션 -->
      <nav class="pagination-nav" th:if="${posts != null}">
        <div class="pagination">
          <a th:if="${posts.number > 0}"
             th:href="@{/posts(page=0, sort=${param.sort}, direction=${param.direction}, keyword=${param.keyword}, region=${param.region})}"
             class="page-btn first-page" title="첫 페이지">‹‹</a>

          <a th:if="${posts.number > 0}"
             th:href="@{/posts(page=${posts.number - 1}, sort=${param.sort}, direction=${param.direction}, keyword=${param.keyword}, region=${param.region})}"
             class="page-btn prev-page">‹</a>

          <div class="page-numbers">
          <span th:each="i : ${pageNumbers}">
            <a th:if="${i != currentPage + 1}"
               th:href="@{/posts(page=${i - 1}, sort=${param.sort}, direction=${param.direction}, keyword=${param.keyword}, region=${param.region})}"
               th:text="${i}" class="page-btn page-number"></a>
            <span th:if="${i == currentPage + 1}" th:text="${i}"
                  class="page-btn page-number active"></span>
          </span>
          </div>

          <a th:if="${posts.number < posts.totalPages - 1}"
             th:href="@{/posts(page=${posts.number + 1}, sort=${param.sort}, direction=${param.direction}, keyword=${param.keyword}, region=${param.region})}"
             class="page-btn next-page">›</a>

          <a th:if="${posts.number < posts.totalPages - 1}"
             th:href="@{/posts(page=${posts.totalPages - 1}, sort=${param.sort}, direction=${param.direction}, keyword=${param.keyword}, region=${param.region})}"
             class="page-btn last-page" title="마지막 페이지">››</a>
        </div>
      </nav>
    </section>
  </main>
</div>

<div th:replace="~{fragments/footer :: common-footer}"></div>
<div th:replace="~{features/post/post_write :: postWriteModal}"></div>
<div th:replace="~{features/post/post_detail :: postDetailModal}"></div>
<div th:replace="~{features/post/post_edit :: postEditModal}"></div>
<div th:replace="~{fragments/toast :: toast}"></div>

<!-- JS 파일들 -->
<script defer th:src="@{/common/js/toggle_dropdown.js}"></script>
<script defer th:src="@{/common/js/toast_manager.js}"></script>
<script defer th:src="@{/features/post/js/like_manager.js}"></script>
<script defer th:src="@{/features/post/js/modal_manager.js}"></script>
<script defer th:src="@{/features/post/js/post_detail.js}"></script>
<script type="module" th:src="@{/features/post/js/post_write.js}"></script>
<script defer th:src="@{/features/post/js/post_list.js}"></script>

<!-- 사진메타데이터 추출 -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<!-- 구글 지도 자동완성 -->
<script defer src="/features/post/js/location_autocomplete.js"></script>
</body>
</html>