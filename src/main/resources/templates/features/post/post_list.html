<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <th:block th:insert="~{fragments/head :: common-head('게시글 페이지')}"></th:block>
  <meta name="gmaps-api-key" th:content="${@environment.getProperty('google.maps.api-key')}"/>
  <link rel="stylesheet" th:href="@{/features/post/css/post_list.css}">
  <link rel="stylesheet" th:href="@{/features/post/css/post_write_modal.css}">
</head>
<body>

<!-- Header Fragment -->
<div th:replace="~{fragments/header :: common-header}"></div>

<main class="main-content container-max">

  <!-- 검색 및 필터 영역 -->
  <section class="search-filter-section">
    <form th:action="@{/posts}" method="get" class="search-form" id="searchForm">

      <!-- 메인 검색바 -->
      <div class="search-container">
        <div class="search-input-wrapper">
          <input type="text"
                 name="keyword"
                 th:value="${param.keyword}"
                 placeholder="문화유산 이름이나 지역을 검색하세요..."
                 class="search-input"
                 id="searchInput">
          <button type="submit" class="search-btn" title="검색">
            🔍
          </button>
        </div>
      </div>

      <!-- 필터 컨트롤 바 -->
      <div class="filter-controls">

        <!-- 정렬 필터 (탭 형식) -->
        <div class="sort-filter-tabs">
          <input type="radio" name="sort" value="createdAt" id="sort-time"
                 th:checked="${param.sort == null or param.sort == 'createdAt'}"
                 onchange="submitForm()">
          <label for="sort-time" class="sort-tab">
            ⏰ 최신순
          </label>

          <input type="radio" name="sort" value="viewCount" id="sort-view"
                 th:checked="${param.sort == 'viewCount'}"
                 onchange="submitForm()">
          <label for="sort-view" class="sort-tab">
            👁️ 조회순
          </label>

          <input type="radio" name="sort" value="likeCount" id="sort-like"
                 th:checked="${param.sort == 'likeCount'}"
                 onchange="submitForm()">
          <label for="sort-like" class="sort-tab">
            ❤️ 좋아요순
          </label>

          <input type="radio" name="sort" value="commentCount" id="sort-comment"
                 th:checked="${param.sort == 'commentCount'}"
                 onchange="submitForm()">
          <label for="sort-comment" class="sort-tab">
            💬 댓글순
          </label>
        </div>

        <!-- 지역 필터 드롭다운 -->
        <div class="region-filter-container">
          <select name="region" class="region-filter-select" onchange="submitForm()">
            <option value="">🌍 전체 지역</option>
            <option
                th:each="entry : ${T(org.hh.heritagehunters.domain.search.util.RegionCodeMapper).getCodeMap()}"
                th:if="${entry.key != '00'}"
                th:value="${entry.key}"
                th:selected="${param.region == entry.key}"
                th:text="${entry.value}">
            </option>
          </select>
        </div>

        <!-- 추가 컨트롤 버튼들 -->
        <div class="control-buttons">
          <!-- 필터 초기화 버튼 -->
          <button type="button"
                  id="clearFiltersBtn"
                  class="control-btn reset-btn"
                  title="필터 초기화">
            🔄 초기화
          </button>


          <!-- 게시글 작성 버튼 -->
          <button type="button"
                  id="openPostModal"
                  class="control-btn new-post-btn"
                  sec:authorize="isAuthenticated()"
                  onclick="PostListManager.openPostModal()">
             게시글 작성
          </button>
        </div>
      </div>

      <!-- 숨겨진 파라미터들 -->
      <input type="hidden" name="direction" th:value="${param.direction ?: 'desc'}">
      <input type="hidden" name="page" value="0">
    </form>
  </section>


  <!-- 게시글 그리드 메인 섹션 -->
  <section class="posts-main-section">

    <!-- 게시글 그리드 (4×4 = 16개) -->
    <div class="posts-grid" id="postsContainer" th:if="${posts != null and !posts.empty}">

      <article class="post-card"
               th:each="post, iterStat : ${posts.content}"
               th:data-post-id="${post.id}"
               th:data-index="${iterStat.index}">

        <a th:href="@{/posts/{id}(id=${post.id})}" class="post-link">

          <!-- ① 이미지 -->
          <div class="post-image-container">
            <img th:if="${post.mainImageUrl != null}"
                 th:src="${post.mainImageUrl}"
                 th:alt="${post.heritage.name + ' - ' + post.content}"
                 class="post-image"
                 loading="lazy">

            <div class="image-count-badge" th:if="${post.images.size() > 1}">
              📷 <span th:text="${post.images.size()}">3</span>
            </div>
          </div> <!-- ✅ 반드시 닫기!! -->

          <!-- ② 유물 종류 → ③ 아이콘 → ④ 좋아요 개수 -->
          <div class="post-info compact">
            <div class="designation-row">
        <span class="designation-pill"
              th:text="${T(org.hh.heritagehunters.domain.search.util.DesignationCodeMapper).getKoreanName(post.heritage.designation)}">
          국보
        </span>
            </div>

            <div class="icons-row" aria-label="빠른 아이콘">
              <span class="icon-heart" title="좋아요">❤️</span>
              <span class="icon-comment" title="댓글">💬</span>
            </div>

            <div class="likes-row">
              <span class="likes-label">좋아요</span>
              <strong class="likes-count" th:text="${post.likeCount}">0</strong>
            </div>
          </div>

          <!-- ⑤ 게시글 작성 날짜 -->
          <div class="post-meta">
            <time class="post-date"
                  th:datetime="${post.createdAt}"
                  th:text="${#temporals.format(post.createdAt, 'yy/MM/dd')}">
              25/08/05
            </time>
          </div>
        </a>
      </article>
    </div>

    <!-- 빈 상태 (게시글이 없을 때) -->
    <div th:if="${posts == null or posts.empty}" class="empty-state">
      <div class="empty-content">
        <div class="empty-icon">🏛️</div>
        <h3 class="empty-title">조건에 맞는 게시글이 없습니다</h3>
        <p class="empty-description">
          <span th:if="${param.keyword != null or param.region != null}">
            다른 검색어나 필터를 사용해보세요
          </span>
          <span th:unless="${param.keyword != null or param.region != null}">
            첫 번째 게시글을 작성해보세요!
          </span>
        </p>

        <div class="empty-actions">
          <button type="button"
                  id="openPostModalEmpty"
                  class="btn-primary"
                  sec:authorize="isAuthenticated()">
            ✏️ 첫 번째 게시글 작성하기
          </button>

          <a th:href="@{/posts}"
             class="btn-secondary"
             th:if="${param.keyword != null or param.region != null}">
            🔄 전체 게시글 보기
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- 페이지네이션 -->
  <nav class="pagination-nav" th:if="${posts != null and posts.totalPages > 1}">
    <div class="pagination">

      <!-- 첫 페이지 -->
      <a th:if="${posts.number > 0}"
         th:href="@{/posts(page=0, sort=${param.sort}, direction=${param.direction}, keyword=${param.keyword}, region=${param.region})}"
         class="page-btn first-page"
         title="첫 페이지">
        ⏮️ 처음
      </a>

      <!-- 이전 페이지 -->
      <a th:if="${posts.number > 0}"
         th:href="@{/posts(page=${posts.number - 1}, sort=${param.sort}, direction=${param.direction}, keyword=${param.keyword}, region=${param.region})}"
         class="page-btn prev-page">
        ‹ 이전
      </a>

      <!-- 페이지 번호들 -->
      <div class="page-numbers">
        <span
            th:each="i : ${#numbers.sequence(T(java.lang.Math).max(0, posts.number - 2), T(java.lang.Math).min(posts.totalPages - 1, posts.number + 2))}">
          <a th:if="${i != posts.number}"
             th:href="@{/posts(page=${i}, sort=${param.sort}, direction=${param.direction}, keyword=${param.keyword}, region=${param.region})}"
             th:text="${i + 1}"
             class="page-btn page-number">
          </a>
          <span th:if="${i == posts.number}"
                th:text="${i + 1}"
                class="page-btn page-number active">
          </span>
        </span>
      </div>

      <!-- 다음 페이지 -->
      <a th:if="${posts.number < posts.totalPages - 1}"
         th:href="@{/posts(page=${posts.number + 1}, sort=${param.sort}, direction=${param.direction}, keyword=${param.keyword}, region=${param.region})}"
         class="page-btn next-page">
        다음 ›
      </a>

      <!-- 마지막 페이지 -->
      <a th:if="${posts.number < posts.totalPages - 1}"
         th:href="@{/posts(page=${posts.totalPages - 1}, sort=${param.sort}, direction=${param.direction}, keyword=${param.keyword}, region=${param.region})}"
         class="page-btn last-page"
         title="마지막 페이지">
        마지막 ⏭️
      </a>
    </div>

  </nav>
</main>

<!-- Footer Fragment -->
<div th:replace="~{fragments/footer :: common-footer}"></div>

<!-- 게시글 작성 모달 포함 -->
<div th:replace="~{features/post/post_write :: postWriteModal}"></div>

<!-- Toast 메시지 Fragment -->
<div th:replace="~{fragments/toast :: toast}"></div>

<!-- 로딩 오버레이 -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>게시글을 불러오는 중...</p>
  </div>
</div>


<!-- JavaScript 파일들 -->
<script type="module" th:src="@{/features/post/js/post_write_modal.js}"></script>
<script th:src="@{/features/post/js/post_list.js}"></script>

<!-- ① 사진 GPS 읽기용 EXIF 파서 -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<!-- 구글 자동완성 -->
<script defer src="/features/post/js/location-autocomplete.js"></script>
</body>
</html>