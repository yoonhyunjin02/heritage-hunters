<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${post.heritage.name + ' - ' + post.content}">게시글 상세 - Heritage Hunters</title>

  <!-- CSS 파일들 -->
  <link rel="stylesheet" th:href="@{/common/css/common.css}">
  <link rel="stylesheet" th:href="@{/features/post/css/post_detail.css}">
</head>
<body>

<!-- Header Fragment -->
<div th:replace="~{fragments/header :: header}"></div>

<main class="main-content">
  
  <!-- 뒤로가기 버튼 -->
  <div class="back-navigation">
    <button onclick="history.back()" class="back-btn">
      ← 뒤로가기
    </button>
  </div>

  <!-- 게시글 상세 컨테이너 -->
  <article class="post-detail-container" th:data-post-id="${post.id}">
    
    <!-- 게시글 헤더 -->
    <header class="post-header">
      <!-- 작성자 정보 -->
      <div class="author-section">
        <div class="author-info">
          <img th:if="${post.user.profile_image != null}"
               th:src="${post.user.profile_image}"
               th:alt="${post.user.nickname}"
               class="author-avatar">
          <div th:unless="${post.user.profile_image != null}"
               class="author-avatar-placeholder">
            <span th:text="${#strings.substring(post.user.nickname, 0, 1)}">H</span>
          </div>
          <div class="author-details">
            <h3 class="author-name" th:text="${post.user.nickname}">사용자닉네임</h3>
            <time class="post-date" 
                  th:datetime="${post.createdAt}"
                  th:text="${#temporals.format(post.createdAt, 'yyyy년 MM월 dd일 HH:mm')}">
              2024년 01월 15일 14:30
            </time>
          </div>
        </div>
        
        <!-- 게시글 메뉴 (작성자만) -->
        <div class="post-menu" th:if="${#authentication.name == post.user.email}">
          <button class="menu-btn" onclick="togglePostMenu()">⋮</button>
          <div class="menu-dropdown" id="postMenuDropdown">
            <a th:href="@{/posts/{id}/edit(id=${post.id})}" class="menu-item">✏️ 수정</a>
            <button class="menu-item delete-btn" th:onclick="'deletePost(' + ${post.id} + ')'">🗑️ 삭제</button>
          </div>
        </div>
      </div>
      
      <!-- 문화유산 정보 -->
      <div class="heritage-info">
        <h1 class="heritage-name" th:text="${post.heritage.name}">서울 숭례문</h1>
        <div class="heritage-meta">
          <span class="designation-badge"
                th:data-designation="${post.heritage.designation}"
                th:text="${T(org.hh.heritagehunters.domain.search.util.DesignationCodeMapper).getKoreanName(post.heritage.designation)}">
            국보
          </span>
        </div>
      </div>
    </header>

    <!-- 게시글 이미지들 -->
    <div class="post-images" th:if="${post.images != null and !post.images.empty}">
      <div class="image-slider" th:if="${post.images.size() > 1}">
        <div class="slider-container">
          <div class="image-slides">
            <div class="slide" 
                 th:each="image, iterStat : ${post.images}" 
                 th:class="'slide' + (${iterStat.index == 0} ? ' active' : '')">
              <img th:src="${image.url}" 
                   th:alt="${post.heritage.name + ' 이미지 ' + (iterStat.index + 1)}"
                   class="post-image">
            </div>
          </div>
          <button class="slider-btn prev-btn" onclick="changeSlide(-1)">‹</button>
          <button class="slider-btn next-btn" onclick="changeSlide(1)">›</button>
          <div class="slide-indicators">
            <span class="indicator" 
                  th:each="image, iterStat : ${post.images}"
                  th:class="'indicator' + (${iterStat.index == 0} ? ' active' : '')"
                  th:onclick="'goToSlide(' + ${iterStat.index} + ')'"></span>
          </div>
        </div>
      </div>
      
      <!-- 단일 이미지 -->
      <div class="single-image" th:if="${post.images.size() == 1}">
        <img th:src="${post.images[0].url}" 
             th:alt="${post.heritage.name + ' 이미지'}"
             class="post-image">
      </div>
    </div>

    <!-- 게시글 본문 -->
    <div class="post-content">
      <p class="post-text" th:text="${post.content}">
        정말 아름다운 문화유산이에요! 직접 보니 더욱 감동적이었습니다. 역사의 깊이를 느낄 수 있었어요.
      </p>
    </div>

    <!-- 위치 정보 -->
    <div class="location-section">
      <h3 class="section-title">📍 위치</h3>
      <div class="location-info">
        <p class="location-text" th:text="${post.location}">서울 중구 세종대로 40</p>
      </div>
    </div>

    <!-- 게시글 통계 및 액션 -->
    <div class="post-stats-actions">
      <div class="stats-display">
        <span class="stat-item">
          👁️ 조회 <span class="stat-number" th:text="${post.viewCount}">127</span>
        </span>
        <span class="stat-item">
          ❤️ 좋아요 <span class="stat-number like-count" th:text="${post.likeCount}">23</span>
        </span>
        <span class="stat-item">
          💬 댓글 <span class="stat-number comment-count" th:text="${post.commentCount}">8</span>
        </span>
      </div>
      
      <div class="action-buttons" sec:authorize="isAuthenticated()">
        <button class="action-btn like-btn" 
                th:class="'action-btn like-btn' + (${isLikedByCurrentUser} ? ' active' : '')"
                th:data-post-id="${post.id}"
                onclick="toggleLike(this)">
          <span class="btn-icon">❤️</span>
          <span class="btn-text">좋아요</span>
        </button>
        
        <button class="action-btn comment-btn" onclick="focusCommentInput()">
          <span class="btn-icon">💬</span>
          <span class="btn-text">댓글 달기</span>
        </button>
        
        <button class="action-btn share-btn" th:onclick="'sharePost(' + ${post.id} + ')'">
          <span class="btn-icon">📤</span>
          <span class="btn-text">공유하기</span>
        </button>
      </div>
    </div>
  </article>

  <!-- 댓글 섹션 -->
  <section class="comments-section">
    <h3 class="section-title">
      💬 댓글 <span class="comment-count" th:text="${post.commentCount}">8</span>개
    </h3>

    <!-- 댓글 작성 (로그인한 사용자만) -->
    <div class="comment-write-section" sec:authorize="isAuthenticated()">
      <form class="comment-form" th:action="@{/posts/{id}/comments(id=${post.id})}" method="post">
        <div class="comment-input-area">
          <div class="commenter-info">
            <img th:if="${#authentication.principal.profile_image != null}"
                 th:src="${#authentication.principal.profile_image}"
                 class="commenter-avatar"
                 alt="내 프로필">
            <div th:unless="${#authentication.principal.profile_image != null}"
                 class="commenter-avatar-placeholder">
              <span th:text="${#strings.substring(#authentication.principal.nickname, 0, 1)}">U</span>
            </div>
          </div>
          
          <div class="comment-input-wrapper">
            <textarea name="content" 
                      id="commentInput"
                      class="comment-input"
                      placeholder="댓글을 입력하세요..."
                      maxlength="300"
                      required></textarea>
            <div class="comment-input-footer">
              <div class="char-counter">
                <span id="commentCharCount">0</span> / 300자
              </div>
              <button type="submit" class="comment-submit-btn">등록</button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- 로그인 안내 (비로그인 사용자) -->
    <div class="login-prompt" sec:authorize="!isAuthenticated()">
      <p>댓글을 작성하려면 <a th:href="@{/login}">로그인</a>이 필요합니다.</p>
    </div>

    <!-- 댓글 리스트 -->
    <div class="comments-list">
      <div class="comment-item" th:each="comment : ${comments}">
        <div class="comment-author-info">
          <img th:if="${comment.user.profile_image != null}"
               th:src="${comment.user.profile_image}"
               th:alt="${comment.user.nickname}"
               class="comment-author-avatar">
          <div th:unless="${comment.user.profile_image != null}"
               class="comment-author-avatar-placeholder">
            <span th:text="${#strings.substring(comment.user.nickname, 0, 1)}">U</span>
          </div>
        </div>
        
        <div class="comment-content">
          <div class="comment-header">
            <span class="comment-author-name" th:text="${comment.user.nickname}">댓글작성자</span>
            <time class="comment-date" 
                  th:datetime="${comment.createdAt}"
                  th:text="${#temporals.format(comment.createdAt, 'MM월 dd일 HH:mm')}">
              01월 15일 14:35
            </time>
          </div>
          
          <p class="comment-text" th:text="${comment.content}">
            정말 멋진 사진이네요! 저도 가보고 싶어졌어요.
          </p>
        </div>
        
        <!-- 댓글 메뉴 (작성자만) -->
        <div class="comment-menu" th:if="${#authentication.name == comment.user.email}">
          <button class="comment-menu-btn" th:onclick="'toggleCommentMenu(' + ${comment.id} + ')'">⋮</button>
          <div class="comment-menu-dropdown" th:id="'commentMenu' + ${comment.id}">
            <button class="menu-item edit-comment-btn" th:onclick="'editComment(' + ${comment.id} + ')'">✏️ 수정</button>
            <button class="menu-item delete-comment-btn" th:onclick="'deleteComment(' + ${comment.id} + ')'">🗑️ 삭제</button>
          </div>
        </div>
      </div>
      
      <!-- 댓글이 없을 때 -->
      <div class="no-comments" th:if="${comments == null or comments.empty}">
        <div class="no-comments-content">
          <span class="no-comments-icon">💬</span>
          <p class="no-comments-text">아직 댓글이 없습니다.</p>
          <p class="no-comments-subtext" sec:authorize="isAuthenticated()">첫 번째 댓글을 작성해보세요!</p>
        </div>
      </div>
    </div>
  </section>
  
  <!-- 관련 게시글 (같은 문화유산) -->
  <section class="related-posts-section" th:if="${relatedPosts != null and !relatedPosts.empty}">
    <h3 class="section-title">🏛️ 관련 게시글</h3>
    <div class="related-posts-grid">
      <a th:each="relatedPost : ${relatedPosts}" 
         th:href="@{/posts/{id}(id=${relatedPost.id})}"
         class="related-post-card">
        <div class="related-post-image">
          <img th:if="${relatedPost.mainImageUrl != null}"
               th:src="${relatedPost.mainImageUrl}"
               th:alt="${relatedPost.heritage.name}"
               loading="lazy">
          <div th:unless="${relatedPost.mainImageUrl != null}" class="related-post-placeholder">
            🏛️
          </div>
        </div>
        <div class="related-post-info">
          <p class="related-post-author" th:text="${relatedPost.user.nickname}">작성자</p>
          <p class="related-post-stats">
            ❤️ <span th:text="${relatedPost.likeCount}">0</span>
            💬 <span th:text="${relatedPost.commentCount}">0</span>
          </p>
        </div>
      </a>
    </div>
  </section>

</main>

<!-- Footer Fragment -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Toast 메시지 Fragment -->
<div th:replace="~{fragments/toast :: toast}"></div>

<!-- JavaScript 파일들 -->
<script th:src="@{/common/js/toast_manager.js}"></script>
<script th:src="@{/features/post/js/post_detail.js}"></script>

</body>
</html>