<!-- features/post/post_edit.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <th:block th:insert="~{fragments/head :: common-head('Postedit - ' + ${post.id})}"></th:block>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <link rel="stylesheet" th:href="@{/features/post/css/modal_common.css}">
  <link rel="stylesheet" th:href="@{/features/post/css/post_write.css}">
  <link rel="stylesheet" th:href="@{/features/post/css/post_detail.css}">
  <link rel="stylesheet" th:href="@{/features/post/css/post_edit.css}">
</head>
<body>

<div th:replace="~{fragments/header :: common-header}"></div>

<div id="postEditModal" class="modal show"
     role="dialog" aria-modal="true" aria-labelledby="postEditTitle"
     th:data-post-id="${post.id}">
  <div class="modal-content">

    <div class="modal-header">
      <h1 id="postEditTitle" class="modal-title">게시글 수정</h1>
      <div class="header-actions">
        <button class="modal-close" onclick="closePostEdit()" aria-label="닫기">&times;</button>
      </div>
    </div>

    <div class="modal-body">
      <div class="composer-grid">
        <!-- 왼쪽: 이미지 영역 -->
        <div class="compose-left" aria-label="게시글 이미지">
          <div class="gallery" th:if="${post.images != null and !post.images.empty}">
            <div class="gallery-main" id="galleryMain">
              <img id="mainImage"
                   th:src="${post.images[0].url}"
                   alt="게시글 이미지"
                   draggable="false">
              <div th:if="${post.images.size() > 1}">
                <button type="button" class="gallery-nav prev" aria-label="이전 이미지">‹</button>
                <button type="button" class="gallery-nav next" aria-label="다음 이미지">›</button>
              </div>
            </div>

            <div class="gallery-thumbs">
              <!-- 기존 이미지 썸네일 -->
              <div class="thumb"
                   th:each="image, it : ${post.images}"
                   th:classappend="${it.index == 0} ? ' active'"
                   th:data-index="${it.index}">
                <img th:src="${image.url}"
                     th:attr="data-full=${image.url}"
                     th:alt="'썸네일 ' + ${it.index + 1}">
                <!-- 유지/삭제 판단 -->
                <input type="hidden" class="keep-image-input" name="keepImages"
                       th:value="${image.id}" form="postEditForm">
                <!-- 편집 전용 삭제 버튼 (button 중첩 방지: span 사용) -->
                <span class="thumb-delete-btn edit-only"
                      th:attr="data-image-id=${image.id}"
                      role="button"
                      tabindex="0"
                      title="삭제">×</span>
              </div>

              <!-- 이미지 추가 버튼 + 파일 입력 -->
              <div class="thumb thumb-add-btn edit-only" role="button" tabindex="0"
                   aria-label="이미지 추가">
                <span class="plus">+</span>
              </div>
              <input id="imageInput" type="file" name="images" accept="image/*" multiple hidden form="postEditForm">
            </div>
          </div>

          <!-- 이미지가 없을 때 -->
          <div class="no-image" th:if="${post.images == null or post.images.empty}">
            이미지를 준비 중입니다.
            <div class="thumb thumb-add-btn edit-only" role="button" tabindex="0"
                 aria-label="이미지 추가">
              <span class="plus">+</span>
            </div>
          </div>
        </div>

        <!-- 오른쪽: 수정 폼 -->
        <form id="postEditForm" th:action="@{/posts/{id}(id=${post.id})}" method="post"
              enctype="multipart/form-data" class="compose-right edit-form">
          <input type="hidden" name="_method" value="PUT">
          <section class="author-display" sec:authorize="isAuthenticated()">
            <img th:if="${currentUser != null and currentUser.profileImage != null}"
                 th:src="${currentUser.profileImage}"
                 class="author-avatar" alt="프로필">
            <img th:if="${currentUser == null and #authentication.principal.profileImage != null}"
                 th:src="${#authentication.principal.profileImage}"
                 class="author-avatar" alt="프로필">
            <div
                th:unless="${(currentUser != null and currentUser.profileImage != null) or (currentUser == null and #authentication.principal.profileImage != null)}"
                class="author-avatar-placeholder">
              <span
                  th:text="${currentUser != null ? #strings.substring(currentUser.nickname, 0, 1) : (#authentication.principal.nickname != null ? #strings.substring(#authentication.principal.nickname, 0, 1) : 'U')}">U</span>
            </div>
            <div class="author-info">
              <div class="author-name"
                   th:text="${currentUser != null ? currentUser.nickname : (#authentication.principal.nickname ?: '사용자')}">
                사용자
              </div>
              <div class="author-time">게시글 수정 중</div>
            </div>
          </section>

          <section class="form-section">
            <label for="content" class="form-label">본문 <span class="required">*</span></label>
            <textarea id="content" name="content" class="form-textarea"
                      placeholder="게시글 내용을 입력하세요..." maxlength="200"
                      required th:text="${post.content}"></textarea>
            <div class="char-count">
              <span id="contentCharCount" th:text="${#strings.length(post.content)}">0</span> /
              200자
            </div>
          </section>

          <section class="form-section">
            <label for="locationInput" class="form-label">위치</label>
            <div class="location-input-wrapper">
              <input type="text" id="locationInput" name="location"
                     class="form-input location-input" th:value="${post.location}"
                     placeholder="위치를 입력하거나 검색하세요..." maxlength="100" autocomplete="off" required>
              <input type="hidden" id="latHidden" name="lat">
              <input type="hidden" id="lngHidden" name="lng">
              <div id="locationSuggestions" class="location-suggestions"></div>
            </div>
          </section>

          <section class="form-actions">
            <button type="button" class="btn-secondary" onclick="PostEdit.cancel()">취소</button>
            <button type="submit" class="btn-primary">수정 완료</button>
          </section>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Fragment: 게시글 수정 모달 -->
<div th:fragment="postEditModal" id="postEditModal" class="modal" style="display:none;"
     role="dialog" aria-modal="true" aria-labelledby="postEditTitle">
  <div class="modal-content">
    <div class="modal-loading">
      <div class="loading-spinner">Loading...</div>
    </div>
  </div>
</div>

<div th:replace="~{fragments/footer :: common-footer}"></div>
<div th:replace="~{fragments/toast :: toast}"></div>

<script defer th:src="@{/features/post/js/modal_manager.js}"></script>
<script defer th:src="@{/features/post/js/post_edit.js}"></script>
<!-- 사진메타데이터 추출 -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<!-- Google Maps API (위치 자동완성) -->
<script defer
        th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${@environment.getProperty('google.maps.api-key')} + '&libraries=places&language=ko'">
</script>
<!-- 구글 지도 자동완성 -->
<script defer src="/features/post/js/location_autocomplete.js"></script>
</body>
</html>