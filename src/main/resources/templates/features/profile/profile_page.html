<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <th:block th:insert="~{fragments/head :: common-head('Profile')}"></th:block>

    <!-- POST 요청을 위한 CSRF 헤더 -->
    <meta name="_csrf" content="[[${_csrf.token}]]" />
    <meta name="_csrf_header" content="[[${_csrf.headerName}]]" />

    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/features/profile/css/profile_page.css}" />
    <!-- 게시물 모달용 CSS -->
    <link rel="stylesheet" th:href="@{/features/post/css/modal-common.css}" />
    <link rel="stylesheet" th:href="@{/features/post/css/post_detail.css}" />
  </head>
  <body>
    <!--header-->
    <div th:replace="~{fragments/header :: common-header}"></div>

    <!--main-->
    <main>
      <!-- 프로필 상단 정보 -->
      <section class="profile-header container-max" aria-labelledby="profile-title">
        <h1 id="profile-title" class="visually-hidden">프로필</h1>

        <div class="profile-header__left">
          <div class="avatar">
            <img
              class="avatar__img"
              th:src="${user.profileImage}"
              th:alt="${user.nickname} + '님의 프로필 사진'"
              alt="프로필 사진"
              onerror="this.onerror=null;this.src='/images/placeholders/no-image.png'"
            />
          </div>

          <div class="user-meta">
            <div class="user-meta__row">
              <span class="user-meta__nickname" th:text="${user.nickname}">닉네임</span>
            </div>
            <div class="user-meta__row">
              <span class="user-meta__email" th:text="${user.email}">email@example.com</span>
            </div>
          </div>
        </div>

        <div class="profile-header__right" aria-label="점수">
          <span class="score__label">점수</span>
          <strong class="score__value" th:text="${#numbers.formatInteger(user.score, 0)}">0</strong>
        </div>
      </section>

      <!-- 탭 내비게이터 -->
      <nav class="profile-tabs container-max" role="tablist" aria-label="프로필 탭">
        <button class="tab-btn" id="tab-stamps" role="tab" aria-controls="panel-stamps" aria-selected="false" tabindex="-1" data-tab="stamps">얻은 우표</button>

        <button class="tab-btn is-active" id="tab-posts" role="tab" aria-controls="panel-posts" aria-selected="true" data-tab="posts">내가 올린 게시물</button>

        <button class="tab-btn" id="tab-liked" role="tab" aria-controls="panel-liked" aria-selected="false" tabindex="-1" data-tab="liked">
          '좋아요' 누른 게시물
        </button>

        <span class="tab-indicator" aria-hidden="true"></span>
      </nav>

      <!-- 탭 패널 -->
      <section class="profile-panels container-max">
        <!-- 얻은 우표 -->
        <div id="panel-stamps" class="tab-panel" role="tabpanel" aria-labelledby="tab-stamps" hidden>
          <ul class="stamp-grid" role="list">
            <li class="stamp-card" th:each="stamp : ${stamps}" th:classappend="${stamp.obtained} ? ' is-obtained' : ' is-locked'">
              <div class="stamp-card__name" th:text="${stamp.name}">우표 이름</div>

              <div class="stamp-card__image">
                <img th:src="${stamp.imageUrl}" th:alt="${stamp.name}" alt="우표 이미지" loading="lazy" />
              </div>

              <div class="stamp-card__date" th:if="${stamp.obtainedAt != null}">
                <span class="stamp-card__date-label">획득일</span>
                <time th:text="${#temporals.format(stamp.obtainedAt, 'yyyy.MM.dd')}">2025.01.01</time>
              </div>

              <div class="stamp-card__date is-pending" th:if="${stamp.obtainedAt == null}">
                <span>미획득</span>
              </div>
            </li>
          </ul>

          <p class="empty-hint" th:if="${#lists.isEmpty(stamps)}">아직 얻은 우표가 없어요.</p>
        </div>

        <!-- 내가 올린 게시물 -->
        <div id="panel-posts" class="tab-panel" role="tabpanel" aria-labelledby="tab-posts">
          <ul class="post-grid" role="list" data-infinite="posts">
            <li class="post-card" th:each="post : ${initialPosts}" th:attr="data-post-id=${post.id}">
              <a href="#" class="post-thumb js-open-lightbox" th:attr="data-post-id=${post.id}" aria-label="게시물 상세 보기">
                <img
                  class="post-thumb__img"
                  th:src="${post.mainImageUrl}"
                  th:alt="${post.heritage != null ? post.heritage.name : '게시물 이미지'}"
                  alt="게시물 썸네일"
                  loading="lazy"
                  onerror="this.onerror=null;this.src='/images/placeholders/no-image.png'"
                />
                <div class="post-thumb__overlay" aria-hidden="true">
                  <span class="overlay-item">
                    <span class="overlay-item__icon" aria-hidden="true">♥</span>
                    <span class="overlay-item__count" th:text="${post.likeCount}">0</span>
                  </span>
                  <span class="overlay-item">
                    <span class="overlay-item__icon" aria-hidden="true">💬</span>
                    <span class="overlay-item__count" th:text="${post.commentCount}">0</span>
                  </span>
                </div>
              </a>
            </li>
          </ul>

          <div class="infinite-sentinel" id="posts-sentinel" aria-hidden="true" th:attr="data-endpoint=@{'/profile/' + ${user.userId} + '/posts'}"></div>

          <!-- 초기 페이지네이션 상태 -->
          <input type="hidden" id="has-next-posts" th:value="${hasNextPosts}" />
          <input type="hidden" id="current-page-posts" value="1" />

          <p class="empty-hint" th:if="${#lists.isEmpty(initialPosts)}">아직 올린 게시물이 없어요.</p>
        </div>

        <!-- '좋아요' 누른 게시물 -->
        <div id="panel-liked" class="tab-panel" role="tabpanel" aria-labelledby="tab-liked" hidden>
          <ul class="post-grid" role="list" data-infinite="liked">
            <li class="post-card" th:each="post : ${initialLiked}" th:attr="data-post-id=${post.id}">
              <a href="#" class="post-thumb js-open-lightbox" th:attr="data-post-id=${post.id}" aria-label="게시물 상세 보기">
                <img
                  class="post-thumb__img"
                  th:src="${post.mainImageUrl}"
                  th:alt="${post.heritage != null ? post.heritage.name : '게시물 이미지'}"
                  alt="게시물 썸네일"
                  loading="lazy"
                  onerror="this.onerror=null;this.src='/images/placeholders/no-image.png'"
                />
                <div class="post-thumb__overlay" aria-hidden="true">
                  <span class="overlay-item">
                    <span class="overlay-item__icon" aria-hidden="true">♥</span>
                    <span class="overlay-item__count" th:text="${post.likeCount}">0</span>
                  </span>
                  <span class="overlay-item">
                    <span class="overlay-item__icon" aria-hidden="true">💬</span>
                    <span class="overlay-item__count" th:text="${post.commentCount}">0</span>
                  </span>
                </div>
              </a>
            </li>
          </ul>

          <div class="infinite-sentinel" id="liked-sentinel" aria-hidden="true" th:attr="data-endpoint=@{'/profile/' + ${user.userId} + '/likes'}"></div>

          <!-- 초기 페이지네이션 상태 -->
          <input type="hidden" id="has-next-liked" th:value="${hasNextLiked}" />
          <input type="hidden" id="current-page-liked" value="1" />

          <p class="empty-hint" th:if="${#lists.isEmpty(initialLiked)}">아직 '좋아요' 누른 게시물이 없어요.</p>
        </div>
      </section>
    </main>

    <div id="post-modal-root" style="display: none">
      <div
        id="postDetailModal"
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="postDetailTitle"
        data-post-id=""
        data-total-images="0"
        data-images=""
        hidden
      >
        <div class="modal-content">
          <!-- 헤더 -->
          <div class="modal-header">
            <h1 id="postDetailTitle" class="modal-title">게시글 상세</h1>
            <div class="header-actions">
              <div class="post-actions">
                <div class="dropdown">
                  <button class="icon-btn" aria-haspopup="menu" aria-expanded="false" onclick="togglePostDropdown()">⋯</button>
                  <div class="dropdown-menu" id="postDropdown" role="menu">
                    <button type="button" class="dropdown-item" role="menuitem" onclick="">수정</button>
                    <button class="dropdown-item delete-item" role="menuitem" onclick="deletePost()">삭제</button>
                  </div>
                </div>
              </div>
              <button class="modal-close" onclick="closePostDetail()" aria-label="닫기">&times;</button>
            </div>
          </div>
          <!-- 로딩 중 상태 -->
          <div class="modal-loading-overlay" id="modalLoading" style="display: none">
            <div class="spinner"></div>
            <p>게시글을 불러오는 중...</p>
          </div>
          <!-- 본문 -->
          <div class="modal-body">
            <div class="composer-grid">
              <!-- 왼쪽: 이미지 영역 -->
              <div class="compose-left" aria-label="게시글 이미지">
                <div class="gallery" id="galleryWrapper">
                  <div class="gallery-main" id="galleryMain">
                    <img id="mainImage" src="" alt="게시글 이미지" draggable="false" />
                    <div class="nav-wrapper">
                      <button class="gallery-nav prev" aria-label="이전 이미지">‹</button>
                      <button class="gallery-nav next" aria-label="다음 이미지">›</button>
                    </div>
                  </div>
                  <div class="gallery-thumbs" id="thumbContainer"></div>
                </div>
              </div>

              <!-- 오른쪽: 작성자/본문/액션/댓글 -->
              <div class="compose-right">
                <section class="author-display">
                  <img id="authorAvatar" class="author-avatar" alt="" />
                  <div class="author-info">
                    <div class="author-name" id="authorName"></div>
                    <time class="author-time" id="postCreatedAt"></time>
                  </div>
                </section>

                <section class="content-box">
                  <p class="content-text" id="postContent"></p>
                </section>

                <section class="actions-box">
                  <button type="button" id="likeBtn" class="icon-action like-button" data-post-id="" aria-pressed="false" title="좋아요">
                    <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
                      <path
                        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12
                  21.23l8.84-8.84a5.5 5.5 0 0 0-0-7.78z"
                        stroke="currentColor"
                        stroke-width="2"
                        fill="none"
                      ></path>
                    </svg>
                    <span class="sr-only">좋아요</span>
                  </button>

                  <button class="icon-action" onclick="focusCommentInput()" title="댓글 달기" aria-label="댓글 달기">
                    <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2" fill="none" />
                    </svg>
                  </button>

                  <div class="stats">
                    <span class="stat"><b id="viewCount">0</b> 조회</span>
                    <span class="stat"><b id="likeCount">0</b> 좋아요</span>
                    <span class="stat"><b id="commentCount">0</b> 댓글</span>
                  </div>
                </section>

                <section class="login-notice" id="loginNotice">댓글을 작성하려면 <a href="/login">로그인</a>이 필요합니다.</section>

                <section class="comments-list" id="commentList"></section>

                <section class="comment-write" id="commentWriteSection">
                  <form class="comment-form" id="commentForm">
                    <textarea id="commentTextarea" name="content" class="comment-input" placeholder="댓글을 입력하세요..." maxlength="200" required></textarea>
                    <div class="comment-tools">
                      <div class="count"><span id="commentCharCount">0</span> / 200자</div>
                      <button type="submit" class="btn-primary">등록</button>
                    </div>
                  </form>
                </section>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!--footer-->
    <div th:replace="~{fragments/footer :: common-footer}"></div>

    <!-- JS -->
    <script type="module" th:src="@{/features/profile/js/profile_main.js}"></script>
  </body>
</html>
